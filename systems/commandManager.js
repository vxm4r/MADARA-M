// ============================================================\n// âš¡ Advanced Command Manager - SOLO Bot\n// ============================================================\n\nimport fs from 'fs-extra';\nimport path from 'path';\nimport chalk from 'chalk';\nimport NodeCache from 'node-cache';\n\nexport class CommandManager {\n    constructor() {\n        this.commands = new Map();\n        this.aliases = new Map();\n        this.categories = new Map();\n        this.commandStats = new Map();\n        this.cache = new NodeCache({ stdTTL: 600 });\n        this.pluginDir = './plugins';\n        this.loadTime = 0;\n    }\n\n    /**\n     * ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ù…Ù† Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ù„Ø­Ù‚Ø§Øª\n     */\n    async loadCommands() {\n        const startTime = Date.now();\n        try {\n            const pluginFiles = fs.readdirSync(this.pluginDir)\n                .filter(f => f.endsWith('.js'))\n                .sort();\n\n            console.log(chalk.cyan(`ðŸ“¦ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ${pluginFiles.length} Ù…Ù„Ø­Ù‚...`));\n            \n            let loadedCount = 0;\n            for (const file of pluginFiles) {\n                try {\n                    const pluginPath = path.join(this.pluginDir, file);\n                    const { default: plugin } = await import(`file://${pluginPath}?t=${Date.now()}`);\n                    \n                    if (plugin && plugin.command) {\n                        this.registerCommand(plugin);\n                        loadedCount++;\n                    }\n                } catch (error) {\n                    console.log(chalk.red(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø­Ù‚ ${file}:`, error.message));\n                }\n            }\n            \n            this.loadTime = Date.now() - startTime;\n            console.log(chalk.green(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${loadedCount} Ù…Ù„Ø­Ù‚ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ ${this.loadTime}ms`));\n            return loadedCount;\n        } catch (error) {\n            console.log(chalk.red('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø­Ù‚Ø§Øª:'), error.message);\n            return 0;\n        }\n    }\n\n    /**\n     * ØªØ³Ø¬ÙŠÙ„ Ø£Ù…Ø± Ø¬Ø¯ÙŠØ¯\n     */\n    registerCommand(plugin) {\n        const command = plugin.command.toLowerCase();\n        \n        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„Ø£Ù…Ø±\n        if (this.commands.has(command)) {\n            console.log(chalk.yellow(`âš ï¸  Ø§Ù„Ø£Ù…Ø± \"${command}\" Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¹Ù„ÙŠÙ‡`));\n        }\n\n        this.commands.set(command, plugin);\n\n        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙØ¦Ø© (Category)\n        const category = plugin.category || 'General';\n        if (!this.categories.has(category)) {\n            this.categories.set(category, []);\n        }\n        this.categories.get(category).push(command);\n\n        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø© (Aliases)\n        if (plugin.aliases && Array.isArray(plugin.aliases)) {\n            plugin.aliases.forEach(alias => {\n                this.aliases.set(alias.toLowerCase(), command);\n            });\n        }\n\n        // ØªÙ‡ÙŠØ¦Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ù…Ø±\n        if (!this.commandStats.has(command)) {\n            this.commandStats.set(command, {\n                command,\n                executed: 0,\n                errors: 0,\n                lastUsed: null,\n                avgExecutionTime: 0\n            });\n        }\n    }\n\n    /**\n     * Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ù…Ø±\n     */\n    getCommand(commandName) {\n        const name = commandName.toLowerCase();\n        \n        // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±\n        if (this.commands.has(name)) {\n            return this.commands.get(name);\n        }\n\n        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø©\n        if (this.aliases.has(name)) {\n            return this.commands.get(this.aliases.get(name));\n        }\n\n        return null;\n    }\n\n    /**\n     * ØªÙ†ÙÙŠØ° Ø£Ù…Ø±\n     */\n    async executeCommand(commandName, message, args, bot) {\n        const startTime = Date.now();\n        const command = this.getCommand(commandName);\n\n        if (!command) {\n            return {\n                success: false,\n                error: 'Ø§Ù„Ø£Ù…Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯',\n                executionTime: Date.now() - startTime\n            };\n        }\n\n        try {\n            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª\n            if (command.permission) {\n                const hasPermission = await this.checkPermission(message, command.permission, bot);\n                if (!hasPermission) {\n                    return {\n                        success: false,\n                        error: 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªÙ†ÙÙŠØ° Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø±',\n                        executionTime: Date.now() - startTime\n                    };\n                }\n            }\n\n            // ØªÙ†ÙÙŠØ° Ø§Ù„Ø£Ù…Ø±\n            const result = await command.execute(message, args, bot);\n            const executionTime = Date.now() - startTime;\n\n            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª\n            this.updateCommandStats(commandName, executionTime, false);\n\n            return {\n                success: true,\n                result,\n                executionTime\n            };\n        } catch (error) {\n            const executionTime = Date.now() - startTime;\n            this.updateCommandStats(commandName, executionTime, true);\n            \n            return {\n                success: false,\n                error: error.message,\n                executionTime\n            };\n        }\n    }\n\n    /**\n     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª\n     */\n    async checkPermission(message, permission, bot) {\n        const sender = message.key.participant || message.key.remoteJid;\n        const jid = message.key.remoteJid;\n\n        switch (permission) {\n            case 'owner':\n                return bot.config?.DEVELOPERS?.includes(sender);\n            case 'admin':\n                if (message.isGroup) {\n                    const metadata = await bot.sock.groupMetadata(jid);\n                    const participant = metadata.participants.find(p => p.id === sender);\n                    return participant && (participant.admin === 'admin' || participant.admin === 'superadmin');\n                }\n                return false;\n            case 'botAdmin':\n                if (message.isGroup) {\n                    const botJid = bot.sock.user?.id;\n                    const metadata = await bot.sock.groupMetadata(jid);\n                    const botParticipant = metadata.participants.find(p => p.id === botJid);\n                    return botParticipant && (botParticipant.admin === 'admin' || botParticipant.admin === 'superadmin');\n                }\n                return false;\n            case 'private':\n                return !message.isGroup;\n            case 'group':\n                return message.isGroup;\n            default:\n                return true;\n        }\n    }\n\n    /**\n     * ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ù…Ø±\n     */\n    updateCommandStats(commandName, executionTime, hasError) {\n        const command = this.getCommand(commandName);\n        if (!command) return;\n\n        const stats = this.commandStats.get(command.command);\n        if (!stats) return;\n\n        stats.executed++;\n        if (hasError) stats.errors++;\n        stats.lastUsed = Date.now();\n        stats.avgExecutionTime = (stats.avgExecutionTime + executionTime) / 2;\n\n        this.commandStats.set(command.command, stats);\n    }\n\n    /**\n     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø£Ù…Ø±\n     */\n    getCommandStats(commandName) {\n        const command = this.getCommand(commandName);\n        if (!command) return null;\n        return this.commandStats.get(command.command);\n    }\n\n    /**\n     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆØ§Ù…Ø±\n     */\n    getAllCommands() {\n        return Array.from(this.commands.values());\n    }\n\n    /**\n     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©\n     */\n    getCommandsByCategory(category) {\n        const commandNames = this.categories.get(category) || [];\n        return commandNames.map(name => this.commands.get(name));\n    }\n\n    /**\n     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª\n     */\n    getAllCategories() {\n        return Array.from(this.categories.keys());\n    }\n\n    /**\n     * Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙˆØ§Ù…Ø±\n     */\n    searchCommands(query) {\n        const lowerQuery = query.toLowerCase();\n        const results = [];\n\n        for (const [name, command] of this.commands.entries()) {\n            if (name.includes(lowerQuery) || \n                command.description?.toLowerCase().includes(lowerQuery)) {\n                results.push(command);\n            }\n        }\n\n        return results;\n    }\n\n    /**\n     * Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆØ§Ù…Ø±\n     */\n    async reloadCommands() {\n        this.commands.clear();\n        this.aliases.clear();\n        this.categories.clear();\n        this.cache.flushAll();\n        return await this.loadCommands();\n    }\n\n    /**\n     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ù…Ø©\n     */\n    getStats() {\n        const stats = Array.from(this.commandStats.values());\n        const totalExecuted = stats.reduce((sum, s) => sum + s.executed, 0);\n        const totalErrors = stats.reduce((sum, s) => sum + s.errors, 0);\n        const avgTime = stats.length > 0 \n            ? stats.reduce((sum, s) => sum + s.avgExecutionTime, 0) / stats.length \n            : 0;\n\n        return {\n            totalCommands: this.commands.size,\n            totalCategories: this.categories.size,\n            totalExecuted,\n            totalErrors,\n            avgExecutionTime: avgTime.toFixed(2),\n            loadTime: this.loadTime\n        };\n    }\n}\n\nexport default CommandManager;\n
