// ============================================================\n// ğŸ¤– ğ’ğğ‹ğ Bot - Advanced WhatsApp Bot\n// ============================================================\n\nimport { makeWASocket, useMultiFileAuthState, DisconnectReason, makeCacheableSignalKeyStore, Browsers } from '@whiskeysockets/baileys';\nimport pino from 'pino';\nimport fs from 'fs-extra';\nimport readline from 'readline';\nimport path from 'path';\nimport chalk from 'chalk';\nimport gradient from 'gradient-string';\nimport { config } from './config.js';\nimport { Handler } from './systems/handler.js';\nimport { EconomySystem } from './systems/economy.js';\nimport { GroupManager } from './systems/groupManager.js';\nimport { AFKSystem } from './systems/afkSystem.js';\nimport { BanSystem } from './systems/banSystem.js';\nimport { CommandManager } from './systems/commandManager.js';\nimport { SimpleMessage } from './lib/simple.js';\n\nconst logger = pino({ level: 'silent' });\n\nclass SOLOBot {\n    constructor() {\n        this.sock = null;\n        this.authState = null;\n        this.saveCreds = null;\n        this.isConnected = false;\n        this.startTime = Date.now();\n        this.connectionRetries = 0;\n        this.maxRetries = config.MAX_RETRIES;\n        this.config = config;\n        this.handler = null;\n        this.economy = null;\n        this.groupManager = null;\n        this.afkSystem = null;\n        this.banSystem = null;\n        this.commandManager = null;\n        this.messageHandler = null;\n        \n        global.bot = this;\n    }\n\n    /**\n     * ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙˆØª\n     */\n    async initialize() {\n        try {\n            console.clear();\n            this.showBanner();\n            this.createDirectories();\n            await this.initializeAuth();\n            this.startConnection();\n        } catch (error) {\n            console.log(chalk.red('âŒ Initial setup failed:'), error.message);\n            await this.handleReconnection();\n        }\n    }\n\n    /**\n     * Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ù†Ø± Ø§Ù„ØªØ±Ø­ÙŠØ¨ÙŠ\n     */\n    showBanner() {\n        console.log(gradient.rainbow(`\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\nâ•‘            ğ’ğğ‹ğ BOT SYSTEM v2.0                 â•‘\nâ•‘         Advanced WhatsApp Bot                    â•‘\nâ•‘              Developed by KING                   â•‘\nâ•‘            +201005199558                         â•‘\nâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        `));\n        console.log(chalk.cyan('ğŸš€ Starting advanced WhatsApp bot...\\n'));\n    }\n\n    /**\n     * Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©\n     */\n    createDirectories() {\n        const dirs = [\n            config.SESSION_PATH,\n            './plugins',\n            './data',\n            './temp'\n        ];\n        dirs.forEach(dir => fs.ensureDirSync(dir));\n    }\n\n    /**\n     * ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©\n     */\n    async initializeAuth() {\n        try {\n            const { state, saveCreds } = await useMultiFileAuthState(config.SESSION_PATH);\n            this.authState = state;\n            this.saveCreds = saveCreds;\n            console.log(chalk.green('âœ… Auth system initialized'));\n        } catch (error) {\n            console.log(chalk.red('âŒ Auth initialization failed:'), error.message);\n            throw error;\n        }\n    }\n\n    /**\n     * Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ WhatsApp\n     */\n    async startConnection() {\n        try {\n            this.sock = makeWASocket({\n                auth: {\n                    creds: this.authState.creds,\n                    keys: makeCacheableSignalKeyStore(this.authState.keys, logger),\n                },\n                logger: logger,\n                printQRInTerminal: false,\n                browser: Browsers.ubuntu('Chrome'),\n                markOnlineOnConnect: true,\n                generateHighQualityLinkPreview: true,\n                syncFullHistory: false,\n                retryRequestDelayMs: 1000,\n                maxRetries: 3,\n            });\n\n            this.setupEventHandlers();\n\n            if (this.authState.creds.registered) {\n                await this.waitForConnection();\n            } else {\n                await this.startPhoneAuth();\n            }\n        } catch (error) {\n            console.log(chalk.red('âŒ Connection failed:'), error.message);\n            throw error;\n        }\n    }\n\n    /**\n     * Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„\n     */\n    async waitForConnection() {\n        return new Promise((resolve) => {\n            const connectionHandler = (update) => {\n                if (update.connection === 'open') {\n                    this.sock.ev.off('connection.update', connectionHandler);\n                    resolve();\n                }\n            };\n            this.sock.ev.on('connection.update', connectionHandler);\n        });\n    }\n\n    /**\n     * Ø¨Ø¯Ø¡ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø¹Ø¨Ø± Ø§Ù„Ù‡Ø§ØªÙ\n     */\n    async startPhoneAuth() {\n        const rl = readline.createInterface({\n            input: process.stdin,\n            output: process.stdout\n        });\n\n        try {\n            const phoneNumber = await new Promise((resolve) => {\n                rl.question(chalk.cyan('ğŸ“± Enter phone number (with country code): '), resolve);\n            });\n\n            if (!phoneNumber) {\n                console.log(chalk.red('âŒ Phone number required'));\n                process.exit(1);\n            }\n\n            const cleanNumber = phoneNumber.replace(/[+\\s]/g, '');\n            console.log(chalk.cyan('â³ Requesting pairing code...'));\n            \n            const code = await this.sock.requestPairingCode(cleanNumber);\n            \n            console.log(chalk.cyan('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—'));\n            console.log(chalk.cyan('â•‘         ğŸ“± PAIRING CODE         â•‘'));\n            console.log(chalk.cyan('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'));\n            console.log(chalk.bold.greenBright(`\\n          \nâ•­â”€â”€â”€ â€¢ ğ’ğğ‹ğ â€¢ â”€â”€â”€â•®\nâ”‚â‰  ğ‘ªğ‘¶ğ‘«ğ‘¬: ${code}\nâ”‚â‰  ğ‘ºğ‘¶ğ‘³ğ‘¶.. \nâ•°â”€â”€â”€ â€¢ ğ’ğğ‹ğ â€¢ â”€â”€â”€\n\\n`));\n            \n            console.log(chalk.cyan('â³ Waiting for pairing... (2 minutes)'));\n            \n            await this.waitForConnection();\n            \n            rl.close();\n            console.log(chalk.green('âœ… Paired successfully!'));\n        } catch (error) {\n            console.log(chalk.red('âŒ Phone auth failed:'), error.message);\n            rl.close();\n            throw error;\n        }\n    }\n\n    /**\n     * Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø«\n     */\n    setupEventHandlers() {\n        this.sock.ev.on('connection.update', (update) => {\n            this.handleConnectionUpdate(update);\n        });\n\n        this.sock.ev.on('messages.upsert', (m) => {\n            this.handleMessagesUpsert(m);\n        });\n\n        this.sock.ev.on('creds.update', () => {\n            if (this.saveCreds) {\n                this.saveCreds();\n            }\n        });\n    }\n\n    /**\n     * Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„\n     */\n    async handleConnectionUpdate(update) {\n        const { connection, lastDisconnect } = update;\n        \n        if (connection === 'open') {\n            this.isConnected = true;\n            this.connectionRetries = 0;\n            console.log(chalk.green('âœ… Connected to WhatsApp!'));\n            \n            if (!this.handler) {\n                console.log(chalk.cyan('ğŸš€ First connection, loading all systems...'));\n                await this.loadSystems();\n                console.log(chalk.green('ğŸ‰ ğ’ğğ‹ğ Bot is now fully operational!'));\n            }\n            \n            if (this.saveCreds) {\n                this.saveCreds();\n            }\n        } else if (connection === 'close') {\n            this.isConnected = false;\n            const statusCode = lastDisconnect?.error?.output?.statusCode;\n            \n            const isCriticalError = statusCode === DisconnectReason.loggedOut || \n                                    statusCode === DisconnectReason.connectionReplaced;\n\n            if (isCriticalError) {\n                console.log(chalk.red('âŒ Critical session issue detected. Restarting from scratch...'));\n                try {\n                    fs.rmSync(config.SESSION_PATH, { recursive: true, force: true });\n                } catch (e) {\n                    console.error(chalk.red('âŒ Failed to clean session directory:'), e.message);\n                }\n                process.exit(1);\n            } else {\n                this.startConnection();\n            }\n        }\n    }\n\n    /**\n     * Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø©\n     */\n    async handleMessagesUpsert(m) {\n        try {\n            const message = m.messages[0];\n            if (!message || !message.message || message.key.remoteJid === 'status@broadcast') return;\n            \n            const messageTime = message.messageTimestamp ? message.messageTimestamp * 1000 : Date.now();\n            if (messageTime < this.startTime - 10000) {\n                return;\n            }\n\n            if (this.handler) {\n                await this.handler.handleMessage(message);\n            }\n        } catch (error) {\n            console.log(chalk.red('âŒ Message handling error:'), error.message);\n        }\n    }\n\n    /**\n     * ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†Ø¸Ù…Ø©\n     */\n    async loadSystems() {\n        try {\n            // ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ\n            this.handler = new Handler(this);\n            await this.handler.loadPlugins();\n            \n            // ØªØ­Ù…ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯\n            this.economy = new EconomySystem();\n            this.economy.setSock(this.sock);\n            await this.economy.initialize();\n            \n            // ØªØ­Ù…ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª\n            this.groupManager = new GroupManager();\n            this.groupManager.setSock(this.sock);\n            await this.groupManager.initialize();\n            \n            // ØªØ­Ù…ÙŠÙ„ Ù†Ø¸Ø§Ù… AFK\n            this.afkSystem = new AFKSystem();\n            this.afkSystem.setSock(this.sock);\n            await this.afkSystem.initialize();\n            \n            // ØªØ­Ù…ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¸Ø±\n            this.banSystem = new BanSystem();\n            this.banSystem.setSock(this.sock);\n            await this.banSystem.initialize();\n            \n            // ØªØ­Ù…ÙŠÙ„ Ù…Ø¯ÙŠØ± Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…\n            this.commandManager = new CommandManager();\n            await this.commandManager.loadCommands();\n            \n            // ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…\n            this.messageHandler = new SimpleMessage(this.sock);\n            \n            // Ø­ÙØ¸ Ø¯ÙˆØ±ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª\n            setInterval(async () => {\n                await this.economy.saveData();\n                await this.groupManager.saveData();\n                await this.afkSystem.saveData();\n                await this.banSystem.saveData();\n                this.handler.saveData();\n            }, config.AUTO_SAVE_INTERVAL);\n            \n            // ØªÙ†Ø¸ÙŠÙ Ø¯ÙˆØ±ÙŠ\n            setInterval(() => {\n                this.banSystem.cleanExpiredBans();\n                this.afkSystem.cleanOldAFKData();\n            }, 3600000); // ÙƒÙ„ Ø³Ø§Ø¹Ø©\n            \n            console.log(chalk.green('âœ… All systems loaded successfully'));\n        } catch (error) {\n            console.log(chalk.red('âŒ System loading failed:'), error.message);\n        }\n    }\n\n    /**\n     * Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„\n     */\n    async handleReconnection() {\n        this.connectionRetries++;\n        if (this.connectionRetries > this.maxRetries) {\n            console.log(chalk.red('âŒ Max reconnection attempts reached'));\n            process.exit(1);\n        }\n\n        console.log(chalk.yellow(`ğŸ”„ Reconnection attempt ${this.connectionRetries}/${this.maxRetries}`));\n        await new Promise(resolve => setTimeout(resolve, 3000));\n        await this.initialize();\n    }\n\n    /**\n     * Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©\n     */\n    async sendMessage(jid, content, options = {}) {\n        try {\n            return await this.sock.sendMessage(jid, content, options);\n        } catch (error) {\n            console.log(chalk.red('âŒ Send message error:'), error.message);\n        }\n    }\n\n    /**\n     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…\n     */\n    getSystemInfo() {\n        return {\n            botName: 'ğ’ğğ‹ğ',\n            version: config.BOT_VERSION,\n            uptime: Date.now() - this.startTime,\n            connected: this.isConnected,\n            connectionRetries: this.connectionRetries,\n            messagesProcessed: this.handler?.stats?.messagesProcessed || 0,\n            commandsLoaded: this.commandManager?.commands?.size || 0,\n            usersTracked: this.handler?.userData?.size || 0,\n            groupsTracked: this.handler?.groupData?.size || 0,\n            bannedUsers: this.banSystem?.bannedUsers?.size || 0,\n            afkUsers: this.afkSystem?.afkUsers?.size || 0\n        };\n    }\n}\n\n/**\n * Ù†Ù‚Ø·Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©\n */\nasync function main() {\n    const bot = new SOLOBot();\n    try {\n        await bot.initialize();\n    } catch (error) {\n        console.error(chalk.red('âŒ A critical error occurred during bot initialization:'), error);\n        process.exit(1);\n    }\n}\n\nmain();\n\n/**\n * Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù\n */\nprocess.on('SIGINT', () => {\n    console.log(chalk.yellow('\\nğŸ›‘ Shutting down ğ’ğğ‹ğ Bot...'));\n    process.exit(0);\n});\n\nprocess.on('SIGTERM', () => {\n    console.log(chalk.yellow('\\nğŸ›‘ ğ’ğğ‹ğ Bot terminated'));\n    process.exit(0);\n});\n\nexport default SOLOBot;\n
